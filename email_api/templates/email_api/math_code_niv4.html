{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeu: Compte & Code ‚Äî Kodikids</title>
  <link rel="stylesheet" href="{% static 'email_api/css/style.css' %}">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
  <style>
    /* Game Styles */
    .game-wrapper { max-width: 900px; margin: 40px auto; display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
    .game-area { height: 500px; background: #87CEEB; border: 3px solid #333; border-radius: 12px; position: relative; overflow: hidden; }
    #equation { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.8); padding: 10px 20px; border-radius: 8px; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .balloon { position: absolute; width: 60px; height: 75px; background: #ff5e57; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem; }
    .balloon::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 2px; height: 10px; background: #333; }
    #basket { position: absolute; bottom: 10px; width: 70px; height: 50px; background: #8B4513; border: 5px solid #A0522D; border-bottom: none; border-radius: 10px 10px 0 0; transition: left 0.3s ease-out; }
    .controls-wrapper { background: #f0f4f8; padding: 20px; border-radius: 12px; }
    #code-editor { width: 100%; height: 200px; background: #2d3436; color: #0f0; font-family: 'Courier New', monospace; border: 2px solid #555; border-radius: 8px; padding: 10px; font-size: 1rem; resize: vertical; }
    .button-group { display: flex; gap: 10px; margin-top: 10px; }
    .run-btn, .pause-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
    .run-btn { background: #27ae60; color: white; }
    .run-btn:hover:not(:disabled) { background: #2ecc71; }
    .pause-btn { background: #f39c12; color: white; }
    .pause-btn:hover:not(:disabled) { background: #e67e22; }
    .run-btn:disabled, .pause-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
    .instructions { margin-top: 20px; font-size: 0.9rem; background: white; padding: 15px; border-radius: 8px; }
    .instructions h4 { margin-top: 0; }
    .instructions code { background: #eee; padding: 2px 5px; border-radius: 3px; }
    #score { font-size: 1.2rem; font-weight: bold; text-align: center; margin-bottom: 15px; }
    .win-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; color: #00b894; z-index: 20; }
    .game-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.75); color: white; padding: 20px 30px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; text-align: center; z-index: 25; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <header>
    {% include "email_api/_header.html" %}
  </header>

  <main class="container">
    <section class="tutorial-section text-center">
      <h1 id="game-title" style="font-size: 2.5rem; font-weight: 800;">Jeu : Compte & Code</h1>
      <p id="game-desc" class="lead">Compte les voyelles ou les consonnes dans le mot, puis √©cris du code pour attraper la bonne r√©ponse !</p>
    </section>

    <div class="game-wrapper">
        <div class="game-area" id="game-area">
            <div id="equation"></div>
            <div id="basket"></div>
            <div class="win-overlay" id="win-overlay">
                <span id="win-bravo">üéâ Bravo ! üéâ</span>
                <p id="win-new" style="font-size: 1rem; color: #555;">Nouveau mot...</p>
            </div>
            <div id="game-message" class="game-message"></div>
        </div>
        <div class="controls-wrapper">
            <div id="score">Score: 0</div>
            <label for="code-editor" id="editor-label" style="font-weight: bold;">√âditeur de code :</label>
            <textarea id="code-editor" placeholder="√âcris ton code ici..."></textarea>
            <div class="button-group">
                <button id="run-code" class="run-btn">‚ñ∂Ô∏è Ex√©cuter le code</button>
                <button id="pause-game" class="pause-btn" disabled>‚è∏Ô∏è Pause</button>
            </div>
             <div class="instructions">
                <h4 id="instr-title">Commandes disponibles :</h4>
                <ul>
                    <li><code>right();</code> - <span id="instr-right">D√©place le panier vers la droite.</span></li>
                    <li><code>left();</code> - <span id="instr-left">D√©place le panier vers la gauche.</span></li>
                    <li id="instr-loop">Utilise des boucles pour te d√©placer plusieurs fois !<br><code>for (let i = 0; i < 3; i++) { right(); }</code></li>
                </ul>
            </div>
        </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <span id="footer-text">¬© Play & Learn ‚Äî Enseignement de la programmation, des robots et de l'IA</span>
    </div>
  </footer>

  <script>
    // Game Elements
    const gameArea = document.getElementById('game-area');
    const equationEl = document.getElementById('equation');
    const basketEl = document.getElementById('basket');
    const codeEditor = document.getElementById('code-editor');
    const runBtn = document.getElementById('run-code');
    const scoreEl = document.getElementById('score');
    const winOverlay = document.getElementById('win-overlay');
    const pauseBtn = document.getElementById('pause-game');
    const gameMessageEl = document.getElementById('game-message');

    // Game State
    let score = 0;
    let basketPos = 0;
    let balloons = [];
    let gameInterval;
    let isPaused = false;
    let gameHasStarted = false;
    let problem = {};
    const basketStep = 50; // pixels

    // --- Translation & Word Data ---
    const gameData = {
        words: {
            fr: ['BONJOUR', 'ORDINATEUR', 'PROGRAMMATION', 'AVENTURE', 'ROBOTIQUE', 'INTELLIGENCE'],
            en: ['HELLO', 'COMPUTER', 'PROGRAMMING', 'ADVENTURE', 'ROBOTICS', 'INTELLIGENCE']
        },
        vowels: 'AEIOUY',
        consonants: 'BCDFGHJKLMNPQRSTVWXZ',
        translations: {
            fr: {
                title: "Jeu: Compte & Code",
                gameTitle: "Jeu : Compte & Code",
                gameDesc: "Compte les voyelles ou les consonnes dans le mot, puis √©cris du code pour attraper la bonne r√©ponse !",
                score: "Score",
                editorLabel: "√âditeur de code :",
                editorPlaceholder: "√âcris ton code ici...",
                runBtn: "‚ñ∂Ô∏è Ex√©cuter le code",
                pauseBtn: "‚è∏Ô∏è Pause",
                resumeBtn: "‚ñ∂Ô∏è Reprendre",
                instrTitle: "Commandes disponibles :",
                instrRight: "D√©place le panier vers la droite.",
                instrLeft: "D√©place le panier vers la gauche.",
                instrLoop: "Utilise des boucles pour te d√©placer plusieurs fois !",
                winBravo: "üéâ Bravo ! üéâ",
                winNew: "Nouveau mot...",
                msgMissed: "Dommage ! Le bon ballon a √©t√© manqu√©.",
                msgWrong: (caught, correct) => `Oups ! C'√©tait ${caught}. La bonne r√©ponse √©tait ${correct}.`,
                msgEmpty: "L'√©diteur de code est vide !",
                msgError: (e) => `Erreur dans ton code :\n${e}`,
                footerText: "¬© Play & Learn ‚Äî Enseignement de la programmation, des robots et de l'IA",
                question: (type, word) => `Combien de ${type} dans '${word}' ?`,
                vowels: "voyelles",
                consonants: "consonnes"
            },
            en: {
                title: "Game: Count & Code",
                gameTitle: "Game: Count & Code",
                gameDesc: "Count the vowels or consonants in the word, then write code to catch the correct answer!",
                score: "Score",
                editorLabel: "Code Editor:",
                editorPlaceholder: "Write your code here...",
                runBtn: "‚ñ∂Ô∏è Run Code",
                pauseBtn: "‚è∏Ô∏è Pause",
                resumeBtn: "‚ñ∂Ô∏è Resume",
                instrTitle: "Available Commands:",
                instrRight: "Moves the basket to the right.",
                instrLeft: "Moves the basket to the left.",
                instrLoop: "Use loops to move multiple times!",
                winBravo: "üéâ Well Done! üéâ",
                winNew: "New word...",
                msgMissed: "Too bad! The correct balloon was missed.",
                msgWrong: (caught, correct) => `Oops! That was ${caught}. The correct answer was ${correct}.`,
                msgEmpty: "The code editor is empty!",
                msgError: (e) => `Error in your code:\n${e}`,
                footerText: "¬© Play & Learn ‚Äî Teaching programming, robotics, and AI",
                question: (type, word) => `How many ${type} in '${word}'?`,
                vowels: "vowels",
                consonants: "consonants"
            }
        }
    };
    let currentLang = 'fr';

    function setLanguage(lang) {
        currentLang = lang;
        const T = gameData.translations[lang];
        document.title = T.title;
        document.getElementById('game-title').textContent = T.gameTitle;
        document.getElementById('game-desc').textContent = T.gameDesc;
        scoreEl.textContent = `${T.score}: ${score}`;
        document.getElementById('editor-label').textContent = T.editorLabel;
        document.getElementById('code-editor').placeholder = T.editorPlaceholder;
        runBtn.textContent = T.runBtn;
        pauseBtn.textContent = isPaused ? T.resumeBtn : T.pauseBtn;
        document.getElementById('instr-title').textContent = T.instrTitle;
        document.getElementById('instr-right').textContent = T.instrRight;
        document.getElementById('instr-left').textContent = T.instrLeft;
        document.getElementById('instr-loop').innerHTML = T.instrLoop + '<br><code>for (let i = 0; i < 3; i++) { right(); }</code>';
        document.getElementById('win-bravo').textContent = T.winBravo;
        document.getElementById('win-new').textContent = T.winNew;
        document.getElementById('footer-text').textContent = T.footerText;
        startNewRound();
    }

    // This is a simplified approach. A better way would be a global event bus.
    const langSwitcher = document.querySelector('#lang-switcher');
    if (langSwitcher) {
        langSwitcher.addEventListener('click', () => {
            const newLang = currentLang === 'fr' ? 'en' : 'fr';
            setLanguage(newLang);
        });
    }

    // --- UI Functions ---
    function showMessage(text, duration = 2000) {
        gameMessageEl.textContent = text;
        gameMessageEl.style.display = 'block';
        setTimeout(() => {
            gameMessageEl.style.display = 'none';
        }, duration);
    }

    // --- User-callable functions ---
    function right() {
        const gameAreaWidth = gameArea.offsetWidth;
        const basketWidth = basketEl.offsetWidth;
        basketPos = Math.min(basketPos + basketStep, gameAreaWidth - basketWidth);
        basketEl.style.left = basketPos + 'px';
    }

    function left() {
        basketPos = Math.max(basketPos - basketStep, 0);
        basketEl.style.left = basketPos + 'px';
    }

    // --- Game Logic ---
    function generateProblem() {
        const T = gameData.translations[currentLang];
        const words = gameData.words[currentLang];
        const word = words[Math.floor(Math.random() * words.length)];
        const askForVowels = Math.random() > 0.5;
        
        let count = 0;
        if (askForVowels) {
            for (const char of word) {
                if (gameData.vowels.includes(char.toUpperCase())) {
                    count++;
                }
            }
        } else {
            for (const char of word) {
                if (gameData.consonants.includes(char.toUpperCase())) {
                    count++;
                }
            }
        }
        
        const questionType = askForVowels ? T.vowels : T.consonants;
        problem = { text: T.question(questionType, word), answer: count };
        equationEl.textContent = problem.text;
    }

    function createBalloons() {
        balloons.forEach(b => b.el.remove());
        balloons = [];
        const answers = [problem.answer];
        while (answers.length < 3) {
            const wrongAnswer = problem.answer + (Math.floor(Math.random() * 6) - 3);
            if (!answers.includes(wrongAnswer) && wrongAnswer !== problem.answer && wrongAnswer >= 0) {
                answers.push(wrongAnswer);
            }
        }
        answers.sort(() => Math.random() - 0.5);

        const colors = ['#ff5e57', '#ff9f43', '#00d2d3'];
        answers.forEach((ans, i) => {
            const balloonEl = document.createElement('div');
            balloonEl.className = 'balloon';
            balloonEl.textContent = ans;
            balloonEl.style.background = colors[i % colors.length];
            const balloon = { el: balloonEl, x: Math.random() * (gameArea.offsetWidth - 60), y: -75, speed: Math.random() * 0.5 + 0.5, value: ans };
            balloonEl.style.left = balloon.x + 'px';
            balloonEl.style.top = balloon.y + 'px';
            balloons.push(balloon);
            gameArea.appendChild(balloonEl);
        });
    }

    function updateGame() {
        if (isPaused) return;

        const basketRect = basketEl.getBoundingClientRect();
        balloons.forEach((balloon, index) => {
            balloon.y += balloon.speed;
            balloon.el.style.top = balloon.y + 'px';
            const balloonRect = balloon.el.getBoundingClientRect();
            if (basketRect.left < balloonRect.right && basketRect.right > balloonRect.left && basketRect.top < balloonRect.bottom && basketRect.bottom > balloonRect.top) { handleCatch(balloon); }
            if (balloon.y > gameArea.offsetHeight) {
                balloon.el.remove();
                balloons.splice(index, 1);
                if (balloons.length === 0) { 
                    clearInterval(gameInterval);
                    showMessage(gameData.translations[currentLang].msgMissed, 2500);
                    setTimeout(startNewRound, 2500);
                }
            }
        });
    }

    function handleCatch(caughtBalloon) {
        clearInterval(gameInterval);
        const T = gameData.translations[currentLang];
        if (caughtBalloon.value === problem.answer) {
            score++;
            scoreEl.textContent = `${T.score}: ${score}`;
            winOverlay.style.display = 'flex';
            setTimeout(() => { 
                winOverlay.style.display = 'none'; 
                startNewRound(); 
            }, 2000);
        } else {
            showMessage(T.msgWrong(caughtBalloon.value, problem.answer), 3000);
            score = 0;
            scoreEl.textContent = `${T.score}: ${score}`;
            setTimeout(startNewRound, 3000);
        }
    }

    function runUserCode() {
        const userCode = codeEditor.value;
        const T = gameData.translations[currentLang];
        if (!userCode.trim()) {
            showMessage(T.msgEmpty, 1500);
            return;
        }
        try {
            const userFunction = new Function('right', 'left', userCode);
            userFunction(right, left);

            if (!gameHasStarted) {
                gameInterval = setInterval(updateGame, 1000 / 60);
                gameHasStarted = true;
                pauseBtn.disabled = false;
                runBtn.disabled = true;
                codeEditor.disabled = true;
            }
        } catch (e) {
            showMessage(T.msgError(e.message), 3000);
        }
    }

    function startNewRound() {
        clearInterval(gameInterval);
        const T = gameData.translations[currentLang];
        gameHasStarted = false;
        gameMessageEl.style.display = 'none';
        runBtn.disabled = false;
        codeEditor.disabled = false;
        pauseBtn.disabled = true;
        pauseBtn.textContent = T.pauseBtn;
        isPaused = false;
        codeEditor.value = '';
        basketPos = (gameArea.offsetWidth - basketEl.offsetWidth) / 2;
        basketEl.style.left = basketPos + 'px';
        generateProblem();
        createBalloons();
    }

    pauseBtn.addEventListener('click', () => {
        isPaused = !isPaused;
        const T = gameData.translations[currentLang];
        pauseBtn.textContent = isPaused ? T.resumeBtn : T.pauseBtn;
        codeEditor.disabled = !isPaused;
        runBtn.disabled = !isPaused;
    });

    runBtn.addEventListener('click', runUserCode);
    window.addEventListener('load', startNewRound);
    window.addEventListener('resize', startNewRound);
  </script>
</body>
</html>