{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu: Soccer Block â€” Kodikids</title>
    <link rel="stylesheet" href="{% static 'email_api/css/style.css' %}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš½</text></svg>">
    
    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary: #4CAF50; /* Vert Pelouse */
            --secondary: #FFC107; /* Jaune Ballon */
            --accent: #2196F3; /* Bleu Ciel */
            --danger: #F44336; /* Rouge Danger */
            --dark: #37474F; /* Bleu foncÃ© */
            --light: #F7F9FC;
            --code-bg: #1e1e1e;
            --block-dribble: #4CAF50; /* Dribbler */
            --block-jump: #FFC107; /* Sauter */
            --block-shoot: #03A9F4; /* Tirer/Passer */
            --block-loop: #E76F51;
        }

        body {
            background-color: var(--light);
        }

        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }
        
        /* --- LAYOUT GLOBAL --- */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        /* --- HEADER & LEVEL SELECTOR (Styles prÃ©cÃ©dents conservÃ©s) --- */
        .level-header { text-align: center; padding: 10px 0 20px 0; background: linear-gradient(180deg, #fff 0%, #eef6ff 100%); position: static; /* EmpÃªche l'en-tÃªte de se fixer en haut */ }
        .level-header h2 { color: var(--dark); font-size: 1.8rem; }
        .level-selector { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .level-btn { padding: 8px 20px; border: 2px solid var(--accent); border-radius: 5px; background: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .level-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .level-btn:hover:not(.active) { background: #eef; }

        /* --- ECRAN DE JEU : TERRAIN DE SOCCER --- */
        .game-screen {
            width: 100%; height: 300px;
            /* Changement de fond pour ressembler Ã  un terrain */
            background: linear-gradient(to bottom, var(--accent) 30%, var(--primary) 30%, #44A044 100%);
            border: 4px solid var(--dark); border-radius: 15px;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        #hero-ball {
            font-size: 2.5rem; position: absolute; bottom: 35px; left: 10px;
            transition: bottom 0.4s ease, left 0.8s linear, transform 0.3s;
            z-index: 10; height: 60px; width: 60px;
            display: flex; justify-content: center; align-items: center;
        }

        .element { position: absolute; font-size: 3rem; }
        /* Style spÃ©cifique pour le But */
        .goal { bottom: 35px; right: 20px; font-size: 4rem; z-index: 5; } 

        /* Animation spÃ©cifique pour l'obstacle 'Gant' */
        .glove { animation: wave 1.5s infinite alternate; }

        @keyframes wave { from { transform: translateY(0) rotate(5deg); } to { transform: translateY(-5px) rotate(-5deg); } }


        /* --- INTERFACE DE PROGRAMMATION --- (MÃªme style conservÃ©) */
        .ide-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .blockly-section { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 450px; }
        .toolbox { display: flex; gap: 10px; padding-bottom: 15px; border-bottom: 2px dashed #ddd; margin-bottom: 10px; flex-wrap: wrap; }
        .workspace { flex: 1; background-color: #f4f4f9; border-radius: 8px; padding: 10px; border: 2px inset #eee; overflow-y: auto; display: flex; flex-direction: column; align-items: flex-start; gap: 5px; position: relative; }
        .workspace::before { content: "Glisse tes blocs ici !"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ccc; font-weight: bold; pointer-events: none; z-index: 0; }
        .workspace:not(:empty)::before { display: none; }
        .block { padding: 10px 15px; border-radius: 5px; color: white; font-family: 'Fredoka', sans-serif; cursor: grab; user-select: none; box-shadow: 2px 2px 0px rgba(0,0,0,0.2); width: 140px; text-align: center; position: relative; z-index: 2; margin-bottom: 5px; white-space: nowrap; }
        .block:active { cursor: grabbing; }
        /* Mise Ã  jour des classes de couleur de blocs */
        .b-dribble { background-color: var(--block-dribble); }
        .b-jump { background-color: var(--block-jump); color: #333; }
        .b-shoot { background-color: var(--block-shoot); }
        .b-loop { background-color: var(--block-loop); }
        .block input { width: 30px; text-align: center; border: none; background: rgba(255, 255, 255, 0.4); border-radius: 3px; font-family: inherit; font-weight: bold; color: inherit; margin: 0 5px; }
        .b-loop input { color: #333; }
        .workspace .block::after { content: "âœ–"; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0.5; cursor: pointer; }
        .workspace .block:hover::after { opacity: 1; }
        .code-section { background: var(--code-bg); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; height: 450px; position: relative; }
        .code-header { color: #aaa; font-family: monospace; margin-bottom: 10px; display: flex; justify-content: space-between; }
        textarea { flex: 1; background-color: transparent; color: #a9b7c6; border: none; font-family: 'Courier New', Courier, monospace; font-size: 1rem; resize: none; }
        textarea:focus { outline: none; }
        .controls { grid-column: 1 / -1; display: flex; justify-content: center; gap: 20px; margin-top: 10px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .btn-main { padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: 0.2s; font-family: 'Fredoka', sans-serif; }
        .btn-play { background-color: var(--secondary); color: var(--dark); }
        .btn-play:hover { transform: scale(1.05); }
        .btn-reset { background-color: var(--danger); color: white; }
        .btn-reset:hover { transform: scale(1.05); }
        #console-log { grid-column: 1 / -1; background: #333; color: #0f0; padding: 10px; font-family: monospace; border-radius: 8px; min-height: 40px; text-align: center; }
        @media (max-width: 768px) {
            .ide-container { grid-template-columns: 1fr; }
            .toolbox { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>

    <header>
        {% include "email_api/_header.html" %}
    </header>

    <main class="container">
        <div class="main-container">
        
        <header class="level-header">
            <h1 style="font-size: 2.5rem; font-weight: 800;">Jeu : Soccer Block</h1>
            <h2 id="level-title"></h2>
        </header>

        <div class="game-screen" id="scene">
            <div id="hero-ball">âš½</div>
            <div class="element goal" style="right: 10px; font-size: 4rem;">ðŸ¥…</div>
            </div>
        
        <div id="console-log">// Soccer Block-Lite. Fais un but !</div>

        <div class="controls">
            <button class="btn-main btn-reset" onclick="resetGame(true)">â†º Recommencer</button>
            <button class="btn-main btn-play" onclick="runCode()">â–¶ Lancer l'Action</button>
        </div>

        <div class="ide-container">
            <div class="blockly-section">
                <h3>1. Assemble tes Blocs d'Action</h3>
                <div class="toolbox">
                    <div class="block b-dribble" draggable="true" ondragstart="drag(event)" data-code="dribbler();">ðŸš¶ Dribbler (Avance 10%)</div>
                    <div class="block b-jump" draggable="true" ondragstart="drag(event)" data-code="sauter();">â¬† Sauter (Avance 20%)</div>
                    <div class="block b-shoot" draggable="true" ondragstart="drag(event)" data-code="tirer();">ðŸ‘Ÿ Tirer (Avance 20%)</div>
                    
                    <div class="block b-loop" draggable="true" ondragstart="drag(event)" data-code="for(i=0; i<3; i++){ dribbler(); }" data-loop="true">
                        RÃ©pÃ©ter <input type="number" min="1" max="10" value="3" onchange="updateBlockCode(this)" onclick="event.stopPropagation()"> fois
                        <select onchange="updateBlockCode(this)" onclick="event.stopPropagation()" data-type="action">
                            <option value="dribbler()">Dribbler</option>
                            <option value="sauter()">Sauter</option>
                            <option value="tirer()">Tirer</option>
                        </select>
                    </div>
                    </div>
                <div class="workspace" id="workspace" ondrop="drop(event)" ondragover="allowDrop(event)">
                    </div>
                <small style="color:#888; margin-top:10px; text-align:center;">Clique sur un bloc dans la liste pour le supprimer.</small>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span>action.js</span>
                    <span>Code gÃ©nÃ©rÃ© automatiquement</span>
                </div>
                <textarea id="code-input" placeholder="// Le code JavaScript apparaÃ®tra ici..." spellcheck="false"></textarea>
            </div>
        </div>
        </div>
    </main>

    <footer>
        <div class="container">
          <span>Â© KODIKIDS â€” Enseignement de la programmation, des robots et de l'IA</span>
        </div>
    </footer>

    <script>
        // --- 1. CONFIGURATION JEU & NIVEAUX (ADAPTÃ‰E AU SOCCER) ---
        const ball = document.getElementById('hero-ball'); // Le ballon
        const consoleDiv = document.getElementById('console-log');
        const codeInput = document.getElementById('code-input');
        const workspace = document.getElementById('workspace');
        const scene = document.getElementById('scene');
        
        let ballX = 10; // Position horizontale du ballon
        let ballY = 35; // Hauteur du sol
        let isRunning = false;
        let currentLevel = 1;

        let obstacles = [];
        const GOAL_POSITION = 85; // Le but est atteint si ballX >= 85

        // Structure de donnÃ©es de tous les niveaux
        const levelData = {
            2: {
                title: " Alternance (Boucle + Tir)",
                // Tirer est nÃ©cessaire pour passer le gant (action rapide)
                obstacles: [
                    { type: 'glove', pos: 20 },
                    { type: 'wall', pos: 40 },
                    { type: 'glove', pos: 60 },
                    { type: 'wall', pos: 80 }
                ]
            }
        };

        function getObstacleEmoji(type) {
             if (type === 'wall') return 'ðŸ§±';
             if (type === 'glove') return 'ðŸ§¤';
             return '';
        }
        
        // --- CHARGEMENT DES NIVEAUX ---
        function loadLevel(levelNumber) {
            if (isRunning) return;
            const levelNum = parseInt(levelNumber);
            if (!levelData[levelNum]) {
                log(`// Niveau ${levelNum} non dÃ©fini.`, 'red');
                return;
            }
            
            currentLevel = levelNum;
            const data = levelData[levelNum];
            
            // Mise Ã  jour du titre et des boutons
            document.getElementById('level-title').innerText = data.title;

            // 1. Nettoyer les anciens obstacles visuels et la liste JS
            scene.querySelectorAll('.element:not(.goal)').forEach(el => el.remove());
            obstacles.length = 0; 

            // 2. Ajouter les nouveaux obstacles
            data.obstacles.forEach(o => {
                const el = document.createElement('div');
                el.className = `element ${o.type}`;
                el.style.left = o.pos + '%';
                // Hauteur standard pour les murs et les gants (les gants sont au sol mais bougent)
                el.style.bottom = '35px'; 
                el.innerHTML = getObstacleEmoji(o.type); 
                
                scene.appendChild(el);
                obstacles.push(o); // Ajouter Ã  la liste des collisions
            });

            resetGame(true); // RÃ©initialiser la position et le code
            log(`// Niveau ${levelNum} chargÃ©. DÃ©fi : ${data.title}`, '#FFC107');
        }

        // --- FONCTIONS UTILITAIRES ---
        function log(msg, color='#0f0') { consoleDiv.innerHTML = `<span style="color:${color}">${msg}</span>`; }

        function resetGame(clearCode = false) {
            ballX = 10; ballY = 35; 
            ball.style.left = ballX + '%'; ball.style.bottom = ballY + 'px';
            ball.style.transform = 'rotate(0deg) scale(1)'; ball.innerText = "âš½";
            isRunning = false;
            
            if(clearCode) {
                workspace.innerHTML = "";
                codeInput.value = "";
            }
        }

        // --- 2. MOTEUR D'EXECUTION ---
        
        async function runCode() {
            if(isRunning) return;
            isRunning = true;
            
            // RÃ©initialisation de la position pour le run
            ballX = 10; ballY = 35; 
            ball.style.left = ballX + '%'; ball.style.bottom = ballY + 'px';
            ball.style.transform = 'rotate(0deg) scale(1)'; ball.innerText = "âš½";
            log("InterprÃ©tation des instructions...", "#FFC107");
            
            // 1. Aplatir le code incluant les boucles
            const flattenedCode = flattenLoops(codeInput.value.trim());
            const lines = flattenedCode.split('\n').filter(line => line.trim() !== '');
            
            // 2. ExÃ©cuter chaque ligne
            for (let line of lines) {
                line = line.trim();
                
                let action = '';
                if (line.includes('dribbler')) action = 'dribbler';
                else if (line.includes('sauter')) action = 'sauter';
                else if (line.includes('tirer')) action = 'tirer';
                
                if (action) {
                    await executeAction(action);
                } else {
                    log(`Erreur: Commande non reconnue: ${line}`, "red");
                    isRunning = false; return;
                }

                if(checkCrash()) { isRunning = false; return; }
                
                if(ballX >= GOAL_POSITION) {
                    log(`ðŸ¥… BUT ! Niveau ${currentLevel} marquÃ© !`, "#4CAF50");
                    ball.innerText = "ðŸŽ‰";
                    isRunning = false; return;
                }
            }
            isRunning = false;
            if (ballX < GOAL_POSITION) {
                log("Fin du code. But non atteint.", "red");
            }
        }

        /** Fonction clÃ© pour gÃ©rer les boucles et aplatir le code */
        function flattenLoops(code) {
            const loopRegex = /for\(i=0; i<(\d+); i\+\+\)\{([^}]+)\}/g;
            
            const flatCode = code.replace(loopRegex, (match, count, action) => {
                let repeatedActions = "";
                const actionTrimmed = action.trim();
                const num = parseInt(count);
                
                for (let i = 0; i < num; i++) { 
                    repeatedActions += actionTrimmed + "\n";
                }
                return repeatedActions;
            });

            return flatCode;
        }

        // --- 3. LOGIQUE D'ACTION & COLLISION (ADAPTÃ‰E) ---

        function executeAction(action) {
            return new Promise(resolve => {
                ball.style.transform = 'scale(1) rotate(0deg)';

                if(action === 'dribbler') {
                    ballX += 10; 
                    ball.style.left = ballX + '%';
                    ball.style.transform = 'rotate(360deg)';
                    log(">> Dribble lent...", "white");
                    setTimeout(resolve, 1000);
                }
                else if (action === 'sauter') {
                    ballX += 20; // Saut avance plus loin
                    ball.style.bottom = (ballY + 120) + 'px'; // Monte haut
                    ball.style.left = ballX + '%';
                    log(">> Saut pour franchir le mur !", "white");
                    
                    setTimeout(() => {
                        ball.style.bottom = ballY + 'px';
                        resolve();
                    }, 1000);
                }
                else if (action === 'tirer') {
                    ball.style.transform = 'scale(1.5)'; // Simule l'impact/la vitesse
                    ballX += 20; // Tir avance plus loin
                    ball.style.left = ballX + '%';
                    log(">> Tiiir ! Rapide et prÃ©cis !", "white");
                    
                    setTimeout(() => {
                        resolve(); 
                    }, 1000);
                }
            });
        }

        function checkCrash() {
            let obstacle = obstacles.find(o => Math.abs(o.pos - ballX) < 5);

            if (obstacle) {
                let currentBottom = parseInt(ball.style.bottom);
                let currentScale = ball.style.transform;

                if (obstacle.type === 'wall') {
                    // Les murs sont Ã©vitÃ©s si le ballon saute
                    if (currentBottom < 50) { 
                        crash("ðŸ’¥ BLOQUÃ‰ ! Mur trop haut !", "red"); return true;
                    }
                }
                if (obstacle.type === 'glove') {
                    // Les gants sont Ã©vitÃ©s si le ballon passe rapidement (Tirer) ou Sauter
                    // Un simple dribble est trop lent.
                    if (!currentScale.includes('1.5') && currentBottom < 50) {
                         crash("ðŸ§¤ BLOQUÃ‰ ! Le gardien l'a attrapÃ© !", "red"); return true;
                    }
                }
            }
            return false;
        }

        function crash(msg) {
            log(msg, "red");
            ball.innerText = "âŒ";
            ball.style.transform = "rotate(0deg) scale(1)";
        }

        // --- 4. SYSTEME BLOCKLY-LITE (DRAG & DROP) ---
        // (Identique, sauf pour les noms de fonctions)

        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("html", ev.target.outerHTML); }
        
        function updateBlockCode(element) {
            const block = element.closest('.block');
            const count = block.querySelector('input[type="number"]').value;
            const action = block.querySelector('select[data-type="action"]').value;
            
            const newCode = `for(i=0; i<${count}; i++){ ${action} }`;
            block.dataset.code = newCode;
            
            if (block.parentElement === workspace) {
                updateCodeEditor();
            }
        }

        function drop(ev) {
            ev.preventDefault();
            const originalHtml = ev.dataTransfer.getData("html");
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = originalHtml;
            const newBlock = tempDiv.firstChild;

            newBlock.removeAttribute("draggable");
            
            newBlock.onclick = function() {
                this.remove();
                updateCodeEditor();
            };
            
            if (newBlock.dataset.loop) {
                const input = newBlock.querySelector('input[type="number"]');
                const select = newBlock.querySelector('select[data-type="action"]');
                if (input) input.onchange = () => updateBlockCode(input);
                if (select) select.onchange = () => updateBlockCode(select);
                
                newBlock.querySelectorAll('input, select').forEach(control => {
                    control.onclick = (e) => e.stopPropagation();
                });
            }

            workspace.appendChild(newBlock);
            updateCodeEditor();
        }

        function updateCodeEditor() {
            const blocks = document.querySelectorAll("#workspace .block");
            let fullCode = "";
            blocks.forEach(b => {
                fullCode += b.dataset.code + "\n";
            });
            codeInput.value = fullCode;
            codeInput.style.color = "#fff";
            setTimeout(() => codeInput.style.color = "#a9b7c6", 200);
        }
        
        // Initialisation : charge le Niveau 1 au dÃ©marrage
        loadLevel(2); 

    </script>
</body>
</html>