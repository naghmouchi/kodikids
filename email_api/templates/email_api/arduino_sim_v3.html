{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Niveau 2 : EntrÃ©es & Boutons (Version Stable)</title>
    <link rel="stylesheet" href="{% static 'email_api/css/style.css' %}">
    <style>
        :root { --arduino-teal: #00979C; --dark-bg: #2f3640; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark-bg); color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        .sim-container { display: flex; gap: 20px; padding: 20px; flex: 1; }

        /* Layout */
        .sidebar { width: 250px; background: #f5f6fa; padding: 15px; border-radius: 10px; }
        .main-area { flex-grow: 1; background: #fff; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .code-panel { width: 350px; background: #1e1e1e; color: #fff; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; }
        
        /* Composants */
        .component { background: #fff; border: 2px solid #ccc; padding: 8px; margin-bottom: 10px; border-radius: 5px; cursor: grab; display: flex; align-items: center; gap: 10px; user-select: none; }
        
        /* Arduino Board */
        .arduino-board { width: 450px; height: 320px; background: var(--arduino-teal); position: relative; border-radius: 5px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); color: white; }
        
        /* Zones de dÃ©pÃ´t (Pins) */
        .pin-zone { 
            width: 30px; height: 30px; background: rgba(0,0,0,0.3); border: 2px dashed rgba(255,255,255,0.5); 
            position: absolute; border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 0.7rem; z-index: 10;
        }
        .pin-zone.correct { background: lime; border-color: lime; opacity: 0.5; }
        
        /* Simulation Visuals */
        #sim-led { 
            width: 30px; height: 30px; background: #550000; border-radius: 50%; 
            position: absolute; top: 40%; left: 60%; transition: 0.1s; border: 2px solid #333; 
            z-index: 5;
        }
        #sim-led.on { background: red; box-shadow: 0 0 20px red; }

        /* LE BOUTON INTERACTIF */
        #sim-button { 
            width: 50px; height: 50px; background: #222; border-radius: 8px; 
            position: absolute; top: 38%; left: 28%; cursor: pointer; border: 3px solid #000;
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
            box-shadow: 0 5px 0 #000;
            transition: 0.1s;
        }
        #sim-button:active, #sim-button.pressed { 
            background: #444; 
            transform: translateY(5px); 
            box-shadow: 0 0 0 #000; 
        }
        #sim-button::after { content: 'PRESS'; font-size: 0.6rem; color: #888; font-weight: bold; }

        /* Robot & UI */
        .robot-msg { background: #333; color: #fff; padding: 10px; border-radius: 10px; margin-top: auto; border-left: 5px solid var(--arduino-teal); }
        textarea { width: 100%; height: 250px; background: #2b2b2b; color: #f8f8f2; border: 1px solid #444; font-family: monospace; padding: 10px; margin-top: 10px; resize: none; }
        .btn-run { background: var(--arduino-teal); color: white; padding: 10px; border: none; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .btn-run:hover { background: #007f83; }

        /* Positions Pins */
        #pin-2 { top: 20px; right: 20px; } 
        #pin-13 { top: 20px; right: 100px; } 
        #pin-gnd { bottom: 20px; right: 50px; }
        
        /* Header fix */
        header { background: white; }
    </style>
</head>
<body>

{% include "email_api/_header.html" %}

<div class="sim-container">
<div class="sidebar">
    <h2>Niveau 2 (Input)</h2>
    <div class="component" draggable="true" id="comp-led">ðŸ’¡ LED Rouge</div>
    <div class="component" draggable="true" id="comp-btn">ðŸ”˜ Bouton Poussoir</div>
    <div class="component" draggable="true" id="comp-res">âž– RÃ©sistance (GND)</div>
    <div style="margin-top:20px; font-size:0.9rem; color:#666;">
        <p><strong>Instructions :</strong></p>
        <ol>
            <li>Glisse la LED sur Pin 13.</li>
            <li>Glisse le Bouton sur Pin 2.</li>
            <li>Glisse la RÃ©sistance sur GND.</li>
            <li>Clique sur "Charger & Simuler".</li>
            <li><strong>MAINTIENS</strong> le clic sur le bouton noir "PRESS".</li>
        </ol>
    </div>
</div>

<div class="main-area">
    <div class="arduino-board">
        <span style="position: absolute; top:10px; left:10px;">Arduino UNO</span>
        
        <div id="sim-led" title="LED (Pin 13)"></div>
        <div id="sim-button" title="Clique ici !"></div>

        <div class="pin-zone" id="pin-13" data-role="led">13</div>
        <div class="pin-zone" id="pin-2" data-role="btn">2</div>
        <div class="pin-zone" id="pin-gnd" data-role="gnd">GND</div>
    </div>
    
    <div style="position: absolute; bottom: 20px; left: 20px; width: 80%; display:flex; gap:10px; align-items:center;">
        <div style="font-size: 3rem;">ðŸ¤–</div>
        <div class="robot-msg" id="robot-text">J'attends que tu places les composants...</div>
    </div>
</div>

<div class="code-panel">
    <h3>Code Arduino</h3>
    <textarea id="code-editor" spellcheck="false">
void setup() {
  pinMode(13, OUTPUT);
  pinMode(2, INPUT);
}

void loop() {
  // Lit si le bouton est pressÃ© (HIGH) ou non (LOW)
  int etat = digitalRead(2);

  if (etat == HIGH) {
    digitalWrite(13, HIGH); // Allume la LED
  } else {
    digitalWrite(13, LOW);  // Eteint la LED
  }
  delay(50); // Petite pause pour la stabilitÃ©
}</textarea>
    <button class="btn-run" onclick="runCode()">ðŸš€ Charger & Simuler</button>
</div>
</div>

<script>
    const state = { led: false, btn: false, gnd: false, running: false };
    let buttonPressed = false; 
    
    // --- AUDIO (BEEP) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playBeep() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
        
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    // --- GESTION DU CLIC BOUTON ---
    const simBtn = document.getElementById('sim-button');
    
    simBtn.addEventListener('mousedown', () => { 
        buttonPressed = true; 
        simBtn.classList.add('pressed'); 
    });
    
    window.addEventListener('mouseup', () => { 
        buttonPressed = false; 
        simBtn.classList.remove('pressed'); 
    });

    // --- DRAG & DROP ---
    document.querySelectorAll('.component').forEach(c => {
        c.addEventListener('dragstart', () => c.classList.add('dragging'));
        c.addEventListener('dragend', () => c.classList.remove('dragging'));
    });

    document.querySelectorAll('.pin-zone').forEach(z => {
        z.addEventListener('dragover', e => e.preventDefault());
        z.addEventListener('drop', e => {
            const id = document.querySelector('.dragging').id;
            const role = z.dataset.role;
            const map = {'comp-led':'led', 'comp-btn':'btn', 'comp-res':'gnd'};
            
            if(map[id] === role) {
                state[role] = true; z.classList.add('correct');
                updateRobot("Bien connectÃ© !", "lime");
            }
        });
    });

    function updateRobot(txt, color) {
        const r = document.getElementById('robot-text');
        r.textContent = txt;
        r.style.borderLeftColor = color;
    }

    // --- SIMULATION STABLE (CORRIGÃ‰E) ---
    async function runCode() {
        // 1. VÃ©rification du montage
        if(!state.led || !state.btn || !state.gnd) {
            updateRobot("Erreur : Montage incomplet.", "red"); 
            return;
        }
        
        // CORRECTION 1: DÃ©finition des constantes ARDUINO en JavaScript
        const HIGH = 'HIGH'; 
        const LOW = 'LOW';
        
        state.running = true;
        updateRobot("Simulation lancÃ©e ! Maintiens le clic sur le bouton 'PRESS'.", "#00979C");
        
        const rawCode = document.getElementById('code-editor').value;
        let loopBody = rawCode.match(/void\s+loop\s*\(\)\s*\{([\s\S]*)\}/)[1];

        // CORRECTION 2 & 3: Transpilation C++ vers JS
        loopBody = loopBody
            .replace(/int\s+/g, 'let ')
            .replace(/digitalRead\((\d+)\)/g, 'getPin($1)')
            // Correction 2: Pas de guillemets autour de $2 (HIGH/LOW) pour utiliser les constantes JS
            .replace(/digitalWrite\((\d+),\s*(\w+)\)/g, 'setPin($1, $2)') 
            .replace(/delay\((\d+)\)/g, 'await wait($1)');

        // CORRECTION 4: Construction de la fonction SANS try/catch et PASSAGE de HIGH/LOW
        const loopFn = new Function('getPin', 'setPin', 'wait', 'HIGH', 'LOW', `
            return async function() {
                ${loopBody}
            }
        `);

        // Mapping des fonctions systÃ¨me
        const getPin = (p) => { 
            // Retourne directement la valeur de la constante HIGH ou LOW
            if(p==2) return buttonPressed ? HIGH : LOW; 
            return LOW; 
        };
        
        let lastPin13 = LOW; // Pour Ã©viter de rÃ©pÃ©ter le son si l'Ã©tat ne change pas

        const setPin = (p, v) => { 
            if(p==13) {
                const led = document.getElementById('sim-led');
                if (v === HIGH) {
                    led.classList.add('on');
                    if (lastPin13 === LOW) playBeep(); // Son uniquement au changement d'Ã©tat (OFF -> ON)
                } else {
                    led.classList.remove('on');
                }
                lastPin13 = v;
            }
        };
        const wait = (ms) => new Promise(r => setTimeout(r, ms));

        // CORRECTION 4: Appel de la fonction avec les constantes
        const runLoop = loopFn(getPin, setPin, wait, HIGH, LOW); 
        
        async function cycle() {
            if(!state.running) return;
            try {
                 await runLoop();
            } catch (e) {
                updateRobot("Erreur d'exÃ©cution dans le code. VÃ©rifiez les majuscules et la ponctuation.", "red");
                console.error("Erreur d'exÃ©cution du code transpilÃ©:", e);
                return;
            }
            if(state.running) setTimeout(cycle, 20);
        }
        cycle();
    }
</script>
</body>
</html>