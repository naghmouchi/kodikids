{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Play & Learn ‚Äî Kodikids</title>
  <link rel="stylesheet" href="{% static 'email_api/css/style.css' %}">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <style>
    .animated-title {
      font-size: 2rem;
      font-weight: 800;
      text-align: left;
      color: #2b7cff;
      margin-bottom: 10px;
    }
    @keyframes gradientAnim { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
    .features-subtitle {
      text-align: left;
      font-size: 1rem;
      font-weight: 600;
      background: linear-gradient(90deg, #ff00cc, #3333ff, #00ccff, #ff00cc);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: gradientAnim 4s linear infinite;
      margin-bottom: 30px;
    }
    /* Mini Game Styles */
    .game-container {
      margin: 60px auto;
      text-align: center;
      max-width: 800px;
      padding: 0 20px;
    }
    .game-area {
      position: relative;
      width: 100%;
      height: 300px;
      background-color: #f0f4f8;
      background-image: linear-gradient(#e1e8ed 1px, transparent 1px), linear-gradient(90deg, #e1e8ed 1px, transparent 1px);
      background-size: 20px 20px;
      border: 3px solid #2b7cff;
      border-radius: 12px;
      overflow: hidden;
      margin: 20px auto;
    }
    .sprite {
      position: absolute;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      user-select: none;
      z-index: 10;
    }
    #robot { left: 20px; top: 130px; transition: all 0.1s linear; }
    #obstacle {
      left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 40px; height: 120px; background: #ff5e57;
      position: absolute; border-radius: 4px;
    }
    #target { right: 20px; top: 130px; font-size: 40px; }
    .game-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    
    /* Blockly-style buttons */
    .block-btn {
      border: none; padding: 12px 20px; border-radius: 8px;
      cursor: pointer; font-weight: 700; font-size: 0.9rem; color: white;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2); margin: 5px;
      display: inline-flex; align-items: center; gap: 8px;
      transition: transform 0.1s; font-family: sans-serif;
    }
    .block-btn:active { transform: translateY(4px); box-shadow: none; }
    .btn-move { background-color: #4c97ff; } /* Scratch Motion Blue */
    .btn-turn { background-color: #4c97ff; }

    .win-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: 1.5rem; font-weight: bold; color: #00b894;
      z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .win-overlay.visible { opacity: 1; pointer-events: auto; }
    .confetti {
      position: absolute; width: 8px; height: 8px;
      animation: fall linear forwards; z-index: 15;
    }
    @keyframes fall { to { transform: translateY(300px) rotate(720deg); opacity: 0; } }
    
    /* Footer Styles */
    footer {
      position: relative;
      background: linear-gradient(to bottom, #1a1a2e, #16213e);
      color: #e0e0e0;
      padding: 80px 0 30px;
      margin-top: 80px;
      overflow: hidden;
    }
    .footer-anim-bg {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0; overflow: hidden;
      display: flex; flex-wrap: wrap;
    }
    .footer-container {
      position: relative; z-index: 1;
      max-width: 1200px; margin: 0 auto; padding: 0 20px;
    }
    .footer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 40px;
      margin-bottom: 50px;
      text-align: center;
    }
    .footer-col { display: flex; flex-direction: column; align-items: center; }
    .footer-col h3 {
      color: #4c97ff;
      font-size: 1.4rem;
      margin-bottom: 25px;
      font-weight: 800;
      position: relative;
      display: inline-block;
    }
    .footer-col h3::after {
      content: ''; display: block; width: 50px; height: 3px;
      background: #ff00cc; margin: 10px auto 0; border-radius: 2px;
    }
    .footer-link {
      display: flex; align-items: center; gap: 10px;
      color: #b0b0b0; text-decoration: none; margin-bottom: 15px;
      font-size: 1.1rem; transition: all 0.3s;
    }
    .footer-link:hover { color: #fff; transform: translateX(5px); }
    .footer-copyright {
      text-align: center;
      padding-top: 30px;
      border-top: 1px solid rgba(255,255,255,0.1);
      color: #888; font-size: 0.9rem;
    }
    .anim-cell {
      width: 40px; height: 40px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 50%;
      transform: scale(0.5);
    }
  </style>
</head>
<body>
  <header>
    {% include "email_api/_header.html" %}

  <main class="container" id="main">
    <section class="hero" aria-labelledby="hero-title">
      <div class="hero-background">
        <h1 id="hero-title" data-lang-key="heroTitle">Apprenez √† coder et piloter des robots ‚Äî enfants & adultes</h1>
        <p id="hero-lead" data-lang-key="heroLead">Parcours ludiques et ateliers pratiques : programmation, IA, jeux √©ducatifs et robotique.</p>
        <p style="margin-top:14px"><a class="cta" href="/api/start/" data-lang-key="heroCTA">Commencer</a></p>
      </div>

      <div class="hero-canvas-wrapper" aria-hidden="false" style="flex:1">
        <div class="hero-decor-bg" aria-hidden="true"></div>
        <canvas id="hero-canvas" role="img" aria-label="Animation de points connect√©s"></canvas>

        <div class="hero-overlay" aria-hidden="false">
          <h2 id="rotating-title" style="margin:0;font-size:20px;opacity:1">Robot & IA Learning</h2>
          <p id="rotating-sub" style="margin:8px 0 0;color:var(--muted)" data-lang-key="rotatingSub">Projets visuels et interactifs pour tous.</p>
        </div>
      </div>
    </section>

    <div class="container">
      <h1 class="animated-title">KodiKids : l‚Äôapprentissage du futur</h1>
      <p class="features-subtitle">Accessible √† tous les enfants, aux parents et aux √©ducateurs.</p>
      <div class="carousel">
        <div class="carousel-track">
          <div class="carousel-item">
            <img src="{% static 'email_api/but-non-lucratif.png' %}" alt="Apprendre √† coder" style="width: auto; height: 110px;">
            <h3 data-lang-key="carouselTitle1">Apprendre √† coder</h3>
            <p data-lang-key="carouselDesc1">Parcours ludiques et ateliers pas √† pas.</p>
          </div>
          <div class="carousel-item">
            <img src="{% static 'email_api/stem.png' %}" alt="IA pour tous" style="width: auto; height: 110px;">
            <h3 data-lang-key="carouselTitle2">IA pour tous</h3>
            <p data-lang-key="carouselDesc2">Initiation aux concepts d'IA avec projets visuels.</p>
          </div>
          <div class="carousel-item">
            <img src="{% static 'email_api/canada-flag-v1.png' %}" alt="Robots et jeux" style="width: auto; height: 110px;">
            <h3 data-lang-key="carouselTitle4">Communication</h3>
            <p data-lang-key="carouselDesc3">Programmez des robots et apprenez en jouant.</p>
          </div>
          <div class="carousel-item">
            <img src="{% static 'email_api/mission-logo.png' %}" alt="IA pour tous" style="width: auto; height: 110px;">
            <h3 data-lang-key="carouselTitle4">Communication</h3>
            <p data-lang-key="carouselDesc4">Pr√©sentez vos projets et communiquez vos id√©es.</p>
          </div>
          <div class="carousel-item">
            <img src="{% static 'email_api/network-hub.png' %}" alt="Robots et jeux" style="width: auto; height: 110px;">
            <h3 data-lang-key="carouselTitle5">Carri√®re Tech</h3>
            <p data-lang-key="carouselDesc5">Pr√©parez-vous pour les m√©tiers du num√©rique.</p>
          </div>
        </div>
        <button class="carousel-btn prev" aria-label="Pr√©c√©dent">&#10094;</button>
        <button class="carousel-btn next" aria-label="Suivant">&#10095;</button>
      </div>
    </div>

    <section class="cards" aria-label="programmes">
      <!-- card 1 -->
      <div class="card flip" tabindex="0" aria-labelledby="card1-title">
        <div class="card-inner">
          <div class="card-face card-front" aria-hidden="false">
            <h3 id="card1-title" data-lang-key="card1Title">Apprendre √† coder</h3>
            <p data-lang-key="card1Desc">Ateliers pas √† pas adapt√©s aux d√©butants et aux enfants.</p>
          </div>
          <div class="card-face card-back" aria-hidden="true">
            <h3 data-lang-key="card1BackTitle">Programmer avec</h3>
            <p data-lang-key="card1BackDesc">JavaScript, Python & Scratch</p>
          </div>
        </div>
      </div>

      <!-- card 2 (flip) -->
      <div class="card flip" tabindex="0" aria-labelledby="card2-title">
        <div class="card-inner">
          <div class="card-face card-front" aria-hidden="false">
            <h3 id="card2-title" data-lang-key="card2Title">IA pour tous</h3>
            <p data-lang-key="card2Desc">Initiation aux concepts d'IA avec projets simples et visuels.</p>
          </div>
          <div class="card-face card-back" aria-hidden="true">
            <h3 data-lang-key="card2BackTitle">Atelier IA</h3>
            <p data-lang-key="card2BackDesc">Mini-projets ML visuels ‚Äî Python, notebooks & TinyML</p>
          </div>
        </div>
      </div>

      <!-- card 3 (flip) -->
      <div class="card flip" tabindex="0" aria-labelledby="card3-title">
        <div class="card-inner">
          <div class="card-face card-front" aria-hidden="false">
            <h3 id="card3-title" data-lang-key="card3Title">Robots et jeux</h3>
            <p data-lang-key="card3Desc">Programmez des robots et apprenez en jouant.</p>
          </div>
          <div class="card-face card-back" aria-hidden="true">
            <h3 data-lang-key="card3BackTitle">D√©fis robotiques</h3>
            <p data-lang-key="card3BackDesc">Construisez des missions: Arduino, Blockly et challenges interactifs</p>
          </div>
        </div>
      </div>
    </section>

    <section class="game-container">
      <h2>Mission : Contact</h2>
      <p>Programmez le robot ü§ñ pour envoyer un email üìß en √©vitant le mur !</p>
      <div class="game-area" id="gameArea">
        <div id="robot" class="sprite">ü§ñ</div>
        <div id="obstacle"></div>
        <div id="target" class="sprite">üìß</div>
        <div id="winOverlay" class="win-overlay">
          <div>üéâ Gagn√© !</div>
          <div style="font-size: 1rem; color: #555; margin-top: 10px;">Redirection vers Contact dans <span id="gameTimer">3</span>s...</div>
        </div>
      </div>
      <div class="game-controls">
        <button class="block-btn btn-move" onclick="gameAction('forward')">Avancer</button>
        <button class="block-btn btn-turn" onclick="gameAction('left')">‚Ü∫ Gauche</button>
        <button class="block-btn btn-turn" onclick="gameAction('right')">Droite ‚Üª</button>
      </div>
    </section>
  </main>

  <div id="cookie-banner" class="cookie-banner">
    <p data-lang-key="cookieText">Nous n'utilisons pas de cookies de suivi. En cliquant sur "Accepter", vous acceptez notre politique de confidentialit√©.</p>
    <button id="cookie-accept-btn" class="cookie-accept-btn" data-lang-key="cookieAccept">Accepter</button>
  </div>

  <footer>
    <div class="footer-anim-bg"></div>
    <div class="footer-container">
      <div class="footer-grid">
        <div class="footer-col">
          <h3>Pages</h3>
          <a href="/" class="footer-link">üè† Accueil</a>
          <a href="/api/courses/" class="footer-link">üéì Cours</a>
          <a href="/api/contact/" class="footer-link">üì¨ Contact</a>
        </div>
        <div class="footer-col">
          <h3>Suivez-nous</h3>
          <a href="#" class="footer-link">üìò Facebook</a>
          <a href="#" class="footer-link">üì∫ YouTube</a>
          <a href="#" class="footer-link">üéµ TikTok</a>
        </div>
        <div class="footer-col">
          <h3>Contact</h3>
          <a href="mailto:contact@kodikids.com" class="footer-link">üìß contact@kodikids.com</a>
          <a href="tel:+1234567890" class="footer-link">üìû +1 234 567 890</a>
        </div>
      </div>
      <div class="footer-copyright">
        <span data-lang-key="footerText">¬© Play & Learn ‚Äî Enseignement de la programmation, des robots et de l'IA</span>
      </div>
    </div>
  </footer>

  <script>
  (function(){
    // Particle + linking animation inside hero canvas
    const wrapper = document.querySelector('.hero-canvas-wrapper');
    const canvas = document.getElementById('hero-canvas');
    if(!wrapper || !canvas) return;
    const ctx = canvas.getContext('2d');
    let DPR = Math.max(1, window.devicePixelRatio || 1);
    const COLORS = ['#2b7cff','#ff7a7a','#7af0b3','#f0d36a'];
    let particles = [];
    const MAX_DIST = 140;

    function resize(){
      DPR = Math.max(1, window.devicePixelRatio || 1);
      const w = Math.max(200, Math.floor(wrapper.clientWidth));
      const h = Math.max(120, Math.floor(wrapper.clientHeight));
      canvas.width = Math.floor(w * DPR);
      canvas.height = Math.floor(h * DPR);
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }

    function rand(min,max){ return Math.random()*(max-min)+min; }

    function initParticles(){
      particles = [];
      const W = wrapper.clientWidth, H = wrapper.clientHeight;
      const count = Math.min(60, Math.max(18, Math.round(W/35)));
      for(let i=0;i<count;i++){
        particles.push({
          x: rand(0,W),
          y: rand(0,H),
          vx: rand(-0.5,0.5),
          vy: rand(-0.5,0.5),
          r: rand(2.2,4.6),
          c: COLORS[i % COLORS.length]
        });
      }
    }

    let mouse = {x:-9999,y:-9999,active:false};
    wrapper.addEventListener('mousemove', function(e){
      const r = wrapper.getBoundingClientRect();
      mouse.x = e.clientX - r.left;
      mouse.y = e.clientY - r.top;
      mouse.active = true;
    });
    wrapper.addEventListener('touchmove', function(e){
      const r = wrapper.getBoundingClientRect();
      const t = e.touches[0];
      if(t){ mouse.x = t.clientX - r.left; mouse.y = t.clientY - r.top; mouse.active = true; }
    }, {passive:true});
    wrapper.addEventListener('mouseleave', function(){ mouse.active=false; mouse.x=-9999; mouse.y=-9999; });
    window.addEventListener('resize', function(){ resize(); initParticles(); });

    function hexToRgba(hex,a){
      const h = hex.replace('#','');
      const bigint = parseInt(h,16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return 'rgba('+r+','+g+','+b+','+(a||1)+')';
    }

    function step(){
      const W = wrapper.clientWidth, H = wrapper.clientHeight;
      ctx.clearRect(0,0,W,H);

      // update
      for(let p of particles){
        p.x += p.vx;
        p.y += p.vy;
        if(p.x < 0 || p.x > W) p.vx *= -1;
        if(p.y < 0 || p.y > H) p.vy *= -1;
        if(mouse.active){
          const dx = p.x - mouse.x, dy = p.y - mouse.y;
          const d = Math.sqrt(dx*dx + dy*dy);
          if(d < 80 && d > 0){
            p.vx += (dx/d)*0.03;
            p.vy += (dy/d)*0.03;
          }
        }
      }

      // draw lines
      for(let i=0;i<particles.length;i++){
        for(let j=i+1;j<particles.length;j++){
          const a = particles[i], b = particles[j];
          const dx = a.x - b.x, dy = a.y - b.y;
          const d = Math.sqrt(dx*dx + dy*dy);
          if(d < MAX_DIST){
            const alpha = 1 - d / MAX_DIST;
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            const grad = ctx.createLinearGradient(a.x,a.y,b.x,b.y);
            grad.addColorStop(0, hexToRgba(a.c, 0.9*alpha));
            grad.addColorStop(1, hexToRgba(b.c, 0.9*alpha));
            ctx.strokeStyle = grad;
            ctx.lineWidth = 0.8 + alpha*1.2;
            ctx.stroke();
          }
        }
      }

      // draw points
      for(let p of particles){
        ctx.beginPath();
        ctx.fillStyle = p.c;
        ctx.globalAlpha = 0.95;
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      requestAnimationFrame(step);
    }

    // init
    resize();
    initParticles();
    requestAnimationFrame(step);
  })();
  </script>

  <script>
  (function(){
    // rotating title: Robot & IA Learning -> Play and Learning -> Coding games
    const titles = ['Robot & IA Learning', 'Play and Learning', 'Coding games'];
    const el = document.getElementById('rotating-title');
    if(!el) return;
    let idx = 0;
    const interval = 2600;
    function showNext(){
      el.style.opacity = '0';
      setTimeout(()=>{
        idx = (idx + 1) % titles.length;
        el.textContent = titles[idx];
        el.style.opacity = '1';
      }, 420);
    }
    // start after a short delay
    setTimeout(()=>{ setInterval(showNext, interval); }, interval);
  })();
  </script>

  <script>
  (function(){
    const track = document.querySelector('.carousel-track');
    if (!track) return;

    const items = track.querySelectorAll('.carousel-item');
    const prevBtn = document.querySelector('.carousel-btn.prev');
    const nextBtn = document.querySelector('.carousel-btn.next');
    let index = 0;

    function getVisibleItems() {
      if (window.innerWidth >= 900) return 3;
      if (window.innerWidth >= 600) return 2;
      return 1;
    }

    function updateCarousel() {
      const itemWidth = items[0].offsetWidth;
      const gap = parseInt(window.getComputedStyle(track).gap) || 16;
      track.style.transform = `translateX(-${index * (itemWidth + gap)}px)`;
      prevBtn.style.display = index === 0 ? 'none' : 'flex';
      nextBtn.style.display = index >= items.length - getVisibleItems() ? 'none' : 'flex';
    }

    nextBtn.addEventListener('click', () => { if (index < items.length - getVisibleItems()) { index++; updateCarousel(); } });
    prevBtn.addEventListener('click', () => { if (index > 0) { index--; updateCarousel(); } });
    window.addEventListener('resize', updateCarousel);
    updateCarousel(); // Initial call
  })();
  </script>

  <script>
  (function() {
    // Language switcher logic
    const langSwitcher = document.getElementById('lang-switcher');
    if (!langSwitcher) return;

    const translations = {
      en: {
        heroTitle: "Learn to code and control robots ‚Äî for kids & adults",
        heroLead: "Fun learning paths and hands-on workshops: programming, AI, educational games, and robotics.",
        heroCTA: "Get Started",
        rotatingSub: "Visual and interactive projects for everyone.",
        carouselTitle1: "Learn to Code",
        carouselDesc1: "Fun tracks and step-by-step workshops.",
        carouselTitle2: "AI for Everyone",
        carouselDesc2: "Introduction to AI concepts with visual projects.",
        carouselTitle3: "Robots and Games",
        carouselDesc3: "Program robots and learn by playing.",
        carouselTitle4: "Communication",
        carouselDesc4: "Present your projects and share your ideas.",
        carouselTitle5: "Tech Career",
        carouselDesc5: "Get ready for digital-age jobs.",
        card1Title: "Learn to Code",
        card1Desc: "Step-by-step workshops for beginners and kids.",
        card1BackTitle: "Code with",
        card1BackDesc: "JavaScript, Python & Scratch",
        card2Title: "AI for Everyone",
        card2Desc: "Introduction to AI concepts with simple, visual projects.",
        card2BackTitle: "AI Workshop",
        card2BackDesc: "Visual ML mini-projects ‚Äî Python, notebooks & TinyML",
        card3Title: "Robots and Games",
        card3Desc: "Program robots and learn through play.",
        card3BackTitle: "Robotics Challenges",
        card3BackDesc: "Build missions: Arduino, Blockly, and interactive challenges",
        footerText: "¬© Play & Learn ‚Äî Teaching programming, robotics, and AI",
        cookieText: "We do not use tracking cookies. By clicking 'Accept', you agree to our privacy policy.",
        cookieAccept: "Accept"
      },
      fr: {
        heroTitle: "Apprenez √† coder et piloter des robots ‚Äî enfants & adultes",
        heroLead: "Parcours ludiques et ateliers pratiques : programmation, IA, jeux √©ducatifs et robotique.",
        heroCTA: "Commencer",
        rotatingSub: "Projets visuels et interactifs pour tous.",
        carouselTitle1: "Apprendre √† coder",
        carouselDesc1: "Parcours ludiques et ateliers pas √† pas.",
        carouselTitle2: "IA pour tous",
        carouselDesc2: "Initiation aux concepts d'IA avec projets visuels.",
        carouselTitle3: "Robots et jeux",
        carouselDesc3: "Programmez des robots et apprenez en jouant.",
        carouselTitle4: "Communication",
        carouselDesc4: "Pr√©sentez vos projets et communiquez vos id√©es.",
        carouselTitle5: "Carri√®re Tech",
        carouselDesc5: "Pr√©parez-vous pour les m√©tiers du num√©rique.",
        card1Title: "Apprendre √† coder",
        card1Desc: "Ateliers pas √† pas adapt√©s aux d√©butants et aux enfants.",
        card1BackTitle: "Programmer avec",
        card1BackDesc: "JavaScript, Python & Scratch",
        card2Title: "IA pour tous",
        card2Desc: "Initiation aux concepts d'IA avec projets simples et visuels.",
        card2BackTitle: "Atelier IA",
        card2BackDesc: "Mini-projets ML visuels ‚Äî Python, notebooks & TinyML",
        card3Title: "Robots et jeux",
        card3Desc: "Programmez des robots et apprenez en jouant.",
        card3BackTitle: "D√©fis robotiques",
        card3BackDesc: "Construisez des missions: Arduino, Blockly et challenges interactifs",
        footerText: "¬© Play & Learn ‚Äî Enseignement de la programmation, des robots et de l'IA",
        cookieText: "Nous n'utilisons pas de cookies de suivi. En cliquant sur 'Accepter', vous acceptez notre politique de confidentialit√©.",
        cookieAccept: "Accepter"
      }
    };

    let currentLang = 'fr';

    function setLanguage(lang) {
      const trans = translations[lang];
      document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.dataset.langKey;
        if (trans[key]) {
          el.textContent = trans[key];
        }
      });
      currentLang = lang;
      langSwitcher.textContent = lang === 'fr' ? 'EN' : 'FR';
      document.documentElement.lang = lang;
    }

    langSwitcher.addEventListener('click', () => {
      const newLang = currentLang === 'fr' ? 'en' : 'fr';
      setLanguage(newLang);
    });

  })();
  </script>

  <script>
  (function(){
    // Mini Game Logic
    const robot = document.getElementById('robot');
    const obstacle = document.getElementById('obstacle');
    const target = document.getElementById('target');
    const gameArea = document.getElementById('gameArea');
    const winOverlay = document.getElementById('winOverlay');
    const timerSpan = document.getElementById('gameTimer');
    
    if(!robot || !gameArea) return;

    let robotX = 20, robotY = 130;
    let robotAngle = 0; // 0 = Right
    const step = 20;
    let gameWon = false;

    // --- Sound Effects (Synth) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        if(type === 'move') {
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if(type === 'bump') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        } else if(type === 'win') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.setValueAtTime(600, now + 0.1);
            osc.frequency.setValueAtTime(1000, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.6);
            osc.start(); osc.stop(now + 0.6);
        }
    }

    function spawnConfetti() {
        for(let i=0; i<40; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + '%';
            c.style.top = '-10px';
            c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
            c.style.animationDuration = (Math.random() * 1.5 + 0.5) + 's';
            gameArea.appendChild(c);
        }
    }

    function updatePos() {
        robot.style.left = robotX + 'px';
        robot.style.top = robotY + 'px';
        robot.style.transform = `rotate(${robotAngle}deg)`;
        checkCollision();
    }

    function checkCollision() {
        if(gameWon) return;
        const rRect = robot.getBoundingClientRect(); // Use visual rect for simplicity with transition
        // To be more precise with responsive layout, we calculate logical rect relative to viewport:
        const aRect = gameArea.getBoundingClientRect();
        const rLeft = aRect.left + robotX;
        const rTop = aRect.top + robotY;
        const rRight = rLeft + 40;
        const rBottom = rTop + 40;

        const oRect = obstacle.getBoundingClientRect();
        const tRect = target.getBoundingClientRect();

        // Boundaries
        if (robotX < 0) robotX = 0;
        if (robotY < 0) robotY = 0;
        if (robotX > aRect.width - 40) robotX = aRect.width - 40;
        if (robotY > aRect.height - 40) robotY = aRect.height - 40;

        // Obstacle Collision
        const pad = 5;
        if (!(rRight < oRect.left + pad || rLeft > oRect.right - pad || rBottom < oRect.top + pad || rTop > oRect.bottom - pad)) {
            robotX = 20; robotY = 130; // Reset
            robot.style.left = robotX + 'px'; robot.style.top = robotY + 'px';
            gameArea.style.backgroundColor = '#ffecec';
            playSound('bump');
            setTimeout(() => gameArea.style.backgroundColor = '#f0f4f8', 200);
            return;
        }

        // Target Collision
        if (!(rRight < tRect.left || rLeft > tRect.right || rBottom < tRect.top || rTop > tRect.bottom)) {
            gameWon = true;
            playSound('win');
            spawnConfetti();
            winOverlay.classList.add('visible');
            let timeLeft = 3;
            const interval = setInterval(() => {
                timeLeft--;
                if(timerSpan) timerSpan.textContent = timeLeft;
                if(timeLeft <= 0) { clearInterval(interval); window.location.href = '/api/contact/'; }
            }, 1000);
        }
    }

    window.gameAction = function(action) {
        if(gameWon) return;
        
        if(action === 'left') {
            robotAngle -= 90;
            playSound('move');
        } else if(action === 'right') {
            robotAngle += 90;
            playSound('move');
        } else if(action === 'forward') {
            const rad = robotAngle * (Math.PI / 180);
            const dx = Math.round(Math.cos(rad)) * step;
            const dy = Math.round(Math.sin(rad)) * step;
            robotX += dx;
            robotY += dy;
            playSound('move');
        }
        updatePos();
    };

    document.addEventListener('keydown', (e) => {
        if(gameWon) return;
        if(e.key === 'ArrowUp') { e.preventDefault(); gameAction('forward'); }
        if(e.key === 'ArrowLeft') { e.preventDefault(); gameAction('left'); }
        if(e.key === 'ArrowRight') { e.preventDefault(); gameAction('right'); }
    });
  })();
  </script>

  <script>
  (function() {
    // Cookie Consent Banner
    const banner = document.getElementById('cookie-banner');
    const acceptBtn = document.getElementById('cookie-accept-btn');
    const cookieConsentKey = 'kodikids_cookie_consent';

    if (!localStorage.getItem(cookieConsentKey)) {
      banner.style.display = 'flex';
    }

    acceptBtn.addEventListener('click', () => {
      localStorage.setItem(cookieConsentKey, 'true');
      banner.style.display = 'none';
    });
  })();
  </script>

  <script>
  (function(){
    // Footer Animation with Anime.js
    const bg = document.querySelector('.footer-anim-bg');
    const footer = document.querySelector('footer');
    if(!bg || !footer) return;

    const cellSize = 40;
    let cols, rows;

    function createGrid() {
        bg.innerHTML = '';
        const w = footer.offsetWidth;
        const h = footer.offsetHeight;
        cols = Math.ceil(w / cellSize);
        rows = Math.ceil(h / cellSize);
        bg.style.width = w + 'px';
        bg.style.height = h + 'px';
        
        for (let i = 0; i < cols * rows; i++) {
            const el = document.createElement('div');
            el.classList.add('anim-cell');
            bg.appendChild(el);
        }
        
        // Initial random fade in
        anime({
            targets: '.anim-cell',
            opacity: [0, 0.5],
            delay: anime.stagger(50, {grid: [cols, rows], from: 'center'}),
            easing: 'easeOutQuad'
        });
    }

    createGrid();
    window.addEventListener('resize', createGrid);

    // Idle Animation: Random blinking dots
    function animateRandom() {
        const cells = document.querySelectorAll('.anim-cell');
        if(cells.length === 0) {
            setTimeout(animateRandom, 500);
            return;
        }
        
        const index = Math.floor(Math.random() * cells.length);
        
        anime({
            targets: cells[index],
            scale: [
                {value: 0.85, duration: 500, easing: 'easeInOutQuad'},
                {value: 0.5, duration: 500, easing: 'easeInOutQuad'}
            ],
            opacity: [
                {value: 1, duration: 500, easing: 'linear'},
                {value: 0.5, duration: 500, easing: 'linear'}
            ],
            backgroundColor: [
                {value: Math.random() > 0.5 ? '#4c97ff' : '#ff00cc', duration: 500, easing: 'easeInOutQuad'},
                {value: 'rgba(255, 255, 255, 0.03)', duration: 500, easing: 'easeInOutQuad'}
            ],
            complete: function() {
                setTimeout(animateRandom, Math.random() * 1500 + 500);
            }
        });
    }
    // Start multiple loops for random activity
    setTimeout(animateRandom, 1000);
    setTimeout(animateRandom, 2500);
    setTimeout(animateRandom, 4000);

    footer.addEventListener('click', function(e) {
        const rect = footer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const col = Math.floor(x / cellSize);
        const row = Math.floor(y / cellSize);
        const index = col + row * cols;

        anime({
            targets: '.anim-cell',
            scale: [
                {value: 0.1, easing: 'easeOutSine', duration: 500},
                {value: 0.5, easing: 'easeInOutQuad', duration: 1200}
            ],
            backgroundColor: [
                {value: '#4c97ff', easing: 'easeOutSine', duration: 500},
                {value: 'rgba(255, 255, 255, 0.03)', easing: 'easeInOutQuad', duration: 1200}
            ],
            delay: anime.stagger(50, {grid: [cols, rows], from: index})
        });
    });
  })();
  </script>
</body>
</html>