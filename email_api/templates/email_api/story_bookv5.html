{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Livre Interactif V5 - Lyne et Douda</title>
    <link rel="stylesheet" href="{% static 'email_api/css/style.css' %}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
    <style>
        /* --- Layout Global --- */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: radial-gradient(circle, #2c3e50, #000000); /* Fond sombre */
            touch-action: none;
        }

        header {
            flex: 0 0 auto;
            z-index: 2000;
            background: white;
        }

        #book-viewport {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 2500px;
            width: 100%;
            overflow: hidden;
            font-family: 'Georgia', serif;
        }

        /* --- Styles du Livre --- */
        :root {
            --book-w: 320px;
            --book-h: 480px;
            --page-color: #fdf6e3; /* Papier un peu jauni */
            --dock-bg: #8e44ad; /* Violet */
            --accent-color: #f1c40f;
        }

        #book-wrapper {
            position: relative;
            transform-style: preserve-3d;
            will-change: transform;
            transition: transform 0.4s ease-out;
        }

        .book {
            position: relative;
            width: var(--book-w);
            height: var(--book-h);
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        .page {
            position: absolute;
            width: 100%; height: 100%;
            transform-origin: left;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        .front, .back {
            position: absolute;
            width: 100%; height: 100%;
            padding: 25px;
            box-sizing: border-box;
            backface-visibility: hidden;
            background: var(--page-color);
            border-radius: 2px 5px 5px 2px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 1rem;
            line-height: 1.5;
            color: #2c3e50;
            overflow: hidden;
        }

        .front {
            z-index: 2;
            background: linear-gradient(to right, #e0d5b7 0%, var(--page-color) 5%, var(--page-color) 100%);
            box-shadow: inset -1px 0 5px rgba(0,0,0,0.05), 5px 5px 20px rgba(0,0,0,0.3);
        }

        .back {
            transform: rotateY(180deg);
            background: linear-gradient(to left, #e0d5b7 0%, var(--page-color) 5%, var(--page-color) 100%);
            box-shadow: inset 1px 0 5px rgba(0,0,0,0.05), -5px 5px 20px rgba(0,0,0,0.3);
        }

        .page.flipped { transform: rotateY(-180deg); }

        .book-img {
            width: 100%; height: 180px; object-fit: cover;
            border-radius: 5px; margin: 0 0 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .page-footer {
            position: absolute; bottom: 15px; left: 0; width: 100%;
            text-align: center; font-family: Arial, sans-serif; font-size: 0.7rem; color: #7f8c8d;
        }
        
        /* --- SCROLLABLE CONTENT --- */
        .page-content {
            flex: 1;
            overflow-y: auto; /* Permet le scroll si le texte est trop long */
            padding-right: 5px;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.2) transparent;
        }
        .page-content::-webkit-scrollbar { width: 4px; }
        .page-content::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 4px; }

        /* --- Dock de ContrÃ´le --- */
        .dock {
            position: absolute;
            bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--dock-bg);
            padding: 8px 15px; border-radius: 40px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 5000; color: white;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }

        .dock button { background: none; border: none; color: white; padding: 10px; font-size: 1.1rem; cursor: pointer; transition: transform 0.1s; }
        .dock button:active { transform: scale(0.9); }
        .dock button:disabled { opacity: 0.2; }
        
        .btn-reset {
            background: var(--accent-color) !important; font-size: 0.75rem !important; color: #333 !important;
            font-weight: bold; padding: 6px 12px !important; border-radius: 20px;
            text-transform: uppercase; letter-spacing: 1px; margin: 0 5px;
        }
        .page-counter { font-family: sans-serif; font-size: 0.8rem; min-width: 60px; text-align: center; color: #ecf0f1; }
        .sep { width: 1px; height: 20px; background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    {% include "email_api/_header.html" %}

    <div id="book-viewport">
        <div id="book-wrapper">
            <div class="book" id="book">
                <!-- Les pages seront gÃ©nÃ©rÃ©es ici par JavaScript -->
            </div>
        </div>

        <div class="dock" id="dock">
            <button id="prevBtn" onclick="movePrev()">â—€</button>
            <div class="sep"></div>
            <button onclick="changeZoom(-0.2)">âˆ’</button>
            <button class="btn-reset" onclick="resetView()">Reset</button>
            <button onclick="changeZoom(0.2)">+</button>
            <div class="sep"></div>
            <div class="page-counter" id="pageIndicator">Chargement...</div>
            <div class="sep"></div>
            <button id="nextBtn" onclick="moveNext()">â–¶</button>
        </div>
    </div>

    <script>
        // --- DONNÃ‰ES DE L'HISTOIRE (PAGINATION EXPLICITE) ---
        const story_data = [
            { text: "Aki, lâ€™IA curieuse, apprend tout de Douda et Lyne.", img: "{% static 'email_api/lyneia_1.PNG' %}" }, // Page 1 (Couverture)
            { text: "Dans le grenier de leur grand-pÃ¨re, Lyne et Douda, deux cousines insÃ©parables de huit ans, viennent de faire une dÃ©couverte incroyable. Sous une vieille couverture poussiÃ©reuse se cache un petit robot tout rond avec de grands yeux Ã©teints. Â« Regarde Douda ! Â» sâ€™exclame Lyne en brossant ses cheveux noirs et lisses. Douda ajuste ses lunettes sur son nez et observe la machine avec curiositÃ©. Elles trouvent un bouton Ã  l'arriÃ¨re et, d'un clic, le robot s'allume en boudant : il ne sait pas si les filles sont amies ou ennemies car il ne comprend pas les expressions des visages.", img: "{% static 'email_api/lyneia_1.PNG' %}" },
            { text: "Â« Il a besoin d'une Intelligence Artificielle pour nous comprendre Â», explique Douda en ouvrant un vieux manuel technique. Elle explique Ã  Lyne qu'un robot ne naÃ®t pas intelligent : il faut lui donner un algorithme, c'est-Ã -dire une suite d'instructions magiques pour l'aider Ã  apprendre. Douda dÃ©cide de nommer le robot Aki. Pour qu'Aki sache quand elles sont contentes, elles doivent lui apprendre Ã  reconnaÃ®tre la joie. Mais comment expliquer ce qu'est un sourire Ã  une machine qui ne voit que des chiffres ?", img: "{% static 'email_api/lyneia_3.PNG' %}" },
            { text: "Lyne prend les choses en main pour la phase de collecte des donnÃ©es. Â« Aki, regarde bien ! Â» dit-elle en faisant le plus grand sourire possible. Elle utilise une tablette pour prendre des centaines de photos d'elle-mÃªme : en train de rire, de sourire discrÃ¨tement ou de montrer ses dents. Pour l'IA, ces images sont des informations prÃ©cieuses. Plus il y a de donnÃ©es variÃ©es, plus l'entraÃ®nement sera efficace. Lyne s'amuse Ã  faire des grimaces joyeuses devant l'objectif d'Aki qui enregistre tout.", img: "{% static 'email_api/lyneia_4.PNG' %}" },
            { text: "Les deux cousines s'installent devant l'ordinateur pour lancer l'entraÃ®nement de l'algorithme. Elles regardent les barres de progression dÃ©filer. Â« C'est comme si Aki allait Ã  l'Ã©cole des Ã©motions Â», chuchote Lyne. Douda explique que l'ordinateur compare toutes les photos pour trouver des points communs : la forme de la bouche qui monte, les yeux qui se plissent. C'est ce qu'on appelle la reconnaissance d'images. Elles sont impatientes de voir si leur ami mÃ©canique a enfin compris le concept du bonheur.", img: "{% static 'email_api/lyneia_5.PNG' %}" },
            { text: "Soudain, un problÃ¨me survient ! Aki pointe une banane posÃ©e sur la table et s'exclame d'une voix mÃ©tallique : Â« Joie ! Â». Douda rigole derriÃ¨re ses lunettes : Â« Oh non, c'est une erreur ! L'algorithme se trompe parce que la banane a la mÃªme courbe qu'un sourire. Â» C'est ce qu'on appelle un biais ou une mauvaise interprÃ©tation des donnÃ©es. Douda montre Ã  Aki que pour faire un vrai sourire humain, il faut aussi regarder si les pommettes remontent et si les yeux brillent.", img: "{% static 'email_api/lyneia_6.PNG' %}" },
            { text: "AprÃ¨s quelques corrections, le test final arrive. Lyne et Douda se tiennent devant Aki. Le petit robot scanne leurs visages, analyse les donnÃ©es en une seconde et ses lumiÃ¨res deviennent vertes. Â« Vous Ãªtes heureuses ! Â» lance-t-il joyeusement. Les cousines se regardent, ravies de leur succÃ¨s. Elles ont rÃ©ussi Ã  entraÃ®ner une IA ! DÃ©sormais, Aki ne se contente plus de calculer, il commence enfin Ã  ressentir l'ambiance de la piÃ¨ce grÃ¢ce Ã  tout ce qu'elles lui ont appris.", img: "{% static 'email_api/lyneia_7.PNG' %}" }
        ];

        // --- VARIABLES GLOBALES ---
        const wrapper = document.getElementById('book-wrapper');
        const book = document.getElementById('book');
        const pageIndicator = document.getElementById('pageIndicator');
        
        let totalSheets = 0;
        let scale = 1, currentIdx = 1;
        let pointX = 0, pointY = 0;
        let startX = 0, startY = 0;
        let isPanning = false, initialDist = 0;

        // --- FONCTIONS DE NAVIGATION ---
        function updateTransform() { wrapper.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
        function resetView() { scale = 1; pointX = 0; pointY = 0; updateTransform(); }
        function changeZoom(amt) { scale = Math.min(Math.max(0.6, scale + amt), 4); updateTransform(); }

        function updateUI() {
            document.getElementById('prevBtn').disabled = (currentIdx === 1);
            document.getElementById('nextBtn').disabled = (currentIdx > totalSheets);
            pageIndicator.innerText = `${currentIdx} / ${totalSheets + 1}`;
        }

        function moveNext() {
            if (currentIdx <= totalSheets) {
                const p = document.getElementById(`p${currentIdx}`);
                if (currentIdx === 1) book.style.transform = "translateX(50%)";
                p.classList.add('flipped');
                const savedIdx = currentIdx;
                setTimeout(() => { p.style.zIndex = savedIdx; }, 400);
                currentIdx++;
                if (currentIdx > totalSheets) book.style.transform = "translateX(100%)";
                updateUI();
            }
        }

        function movePrev() {
            if (currentIdx > 1) {
                if (currentIdx > totalSheets) book.style.transform = "translateX(50%)";
                currentIdx--;
                const p = document.getElementById(`p${currentIdx}`);
                p.classList.remove('flipped');
                p.style.zIndex = 100 + (totalSheets - currentIdx); 
                if (currentIdx === 1) book.style.transform = "translateX(0%)";
                updateUI();
            }
        }

        // --- LOGIQUE DE PAGINATION ---
        function generateBook() {
            const pagesData = story_data;
            book.innerHTML = '';

            let sheetCount = 0;
            let pageIdx = 0;

            while (pageIdx < pagesData.length) {
                sheetCount++;
                
                const frontData = pagesData[pageIdx];
                const backData = pagesData[pageIdx+1];

                const frontHTML = buildPageContent(frontData, pageIdx + 1);
                const backHTML = backData ? buildPageContent(backData, pageIdx + 2) : buildPageContent({text:"", img:null}, pageIdx + 2);

                const zIndex = 100 - sheetCount;
                book.appendChild(createSheet(sheetCount, frontHTML, backHTML, zIndex));
                
                pageIdx += 2;
            }

            // Feuille de fin
            sheetCount++;
            const endFront = `<div style="display:flex; align-items:center; justify-content:center; height:100%;"><h1 style="color:#bdc3c7;">FIN</h1></div>`;
            const endBack = `<div style="display:flex; align-items:center; justify-content:center; height:100%;"><small>Â© Kodikids Story</small></div>`;
            book.appendChild(createSheet(sheetCount, endFront, endBack, 100 - sheetCount));

            totalSheets = sheetCount;
            updateUI();
        }

        function buildPageContent(data, pageNum) {
            let html = `<div class="page-content">`;
            // Titre spÃ©cial pour la page 1
            if (pageNum === 1) {
                html += `<h2>Lyne, Douda et l'IA Aki</h2>`;
            }
            
            if (data.img) {
                html += `<img class="book-img" src="${data.img}">`;
            }
            if (data.text) {
                html += `<p>${data.text}</p>`;
            }
            html += `</div><div class="page-footer">${pageNum}</div>`;
            return html;
        }

        function createSheet(id, frontHTML, backHTML, zIndex) {
            const div = document.createElement('div');
            div.className = 'page';
            div.id = `p${id}`;
            div.style.zIndex = zIndex;
            div.innerHTML = `
                <div class="front">${frontHTML}</div>
                <div class="back">${backHTML}</div>
            `;
            return div;
        }

        // --- GESTION DU DOCK DÃ‰PLAÃ‡ABLE (SOURIS + TACTILE) ---
        const dock = document.getElementById('dock');
        let isDockDragging = false;
        let dockOffsetX, dockOffsetY;

        const onDragStart = (clientX, clientY, target) => {
            if (target.tagName === 'BUTTON' || target.closest('button')) return;
            isDockDragging = true;
            dock.style.cursor = 'grabbing';
            dock.style.transition = 'none';
            if (dock.style.bottom !== 'auto') {
                const rect = dock.getBoundingClientRect();
                const parentRect = dock.parentElement.getBoundingClientRect();
                dock.style.left = `${rect.left - parentRect.left}px`;
                dock.style.top = `${rect.top - parentRect.top}px`;
                dock.style.bottom = 'auto';
                dock.style.transform = 'none';
            }
            const rect = dock.getBoundingClientRect();
            dockOffsetX = clientX - rect.left;
            dockOffsetY = clientY - rect.top;
        };

        const onDragMove = (clientX, clientY) => {
            if (!isDockDragging) return;
            const parentRect = dock.parentElement.getBoundingClientRect();
            let newLeft = clientX - parentRect.left - dockOffsetX;
            let newTop = clientY - parentRect.top - dockOffsetY;
            const dockRect = dock.getBoundingClientRect();
            newLeft = Math.max(0, Math.min(newLeft, parentRect.width - dockRect.width));
            newTop = Math.max(0, Math.min(newTop, parentRect.height - dockRect.height));
            dock.style.left = `${newLeft}px`;
            dock.style.top = `${newTop}px`;
        };

        const onDragEnd = () => {
            isDockDragging = false;
            dock.style.cursor = 'grab';
        };

        dock.addEventListener('mousedown', (e) => onDragStart(e.clientX, e.clientY, e.target));
        window.addEventListener('mousemove', (e) => onDragMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', onDragEnd);

        dock.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) onDragStart(e.touches[0].clientX, e.touches[0].clientY, e.target);
        }, { passive: false });

        window.addEventListener('touchstart', (e) => {
            if (isDockDragging) return;
            if (e.touches.length === 2) {
                isPanning = false;
                initialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            } else if (e.touches.length === 1) {
                isPanning = true;
                startX = e.touches[0].clientX - pointX;
                startY = e.touches[0].clientY - pointY;
            }
        }, { passive: false });
        
        window.addEventListener('touchmove', (e) => {
            if (isDockDragging && e.touches.length === 1) {
                e.preventDefault();
                onDragMove(e.touches[0].clientX, e.touches[0].clientY);
                return;
            }
            if (e.touches.length === 2) {
                if (e.cancelable) e.preventDefault();
                const currentDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                if (initialDist > 0) {
                    scale *= (currentDist / initialDist);
                    scale = Math.min(Math.max(0.6, scale), 4);
                    initialDist = currentDist;
                    updateTransform();
                }
            } else if (e.touches.length === 1 && isPanning) {
                if (e.cancelable) e.preventDefault();
                pointX = e.touches[0].clientX - startX;
                pointY = e.touches[0].clientY - startY;
                updateTransform();
            }
        }, { passive: false });
        
        window.addEventListener('touchend', (e) => { onDragEnd(); if(e.touches.length === 0) isPanning = false; });

        window.onload = () => {
            generateBook();
        };
    </script>
</body>
</html>